<FULL LUA SCRIPT FROM ABOVE>